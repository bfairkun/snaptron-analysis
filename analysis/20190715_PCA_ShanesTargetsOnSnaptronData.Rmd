---
title: "20180715_PCA_ShanesTargets"
author: "Ben Fair"
date: "7/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

This analysis was a meta-analysis of all the blood or bone marrow samples I could find in snaptron splice-junction count tables. This amounts to ~6000 samples across TCGA, SRA2, and GTEx. The count table I will load is only the subset of junctions that Shane is using to target. The goal of this is to make sure that measuring splicing at these ~75 targets that Shane chose is enough to clearly distinguish sf3b1-wt from sf3b1-mut, ideally in whole blood (of which there is one GTEx sample in these snaptron datasets that is definitely whole blood and sf3b1 mutant)

```{r libraries}
library(data.table)
library(dplyr)
library(ggplot2)
library(reshape2)
library(readxl)
library(ggrepel)
library(tidyverse)
library(gplots)
library(knitr)
```


```{r}
gsub2 <- function(searchstring, replacestring, query){
  # function like gsub but will return NA if no match
  ind <- grep(searchstring,query,value = FALSE)
  query <- gsub(searchstring, replacestring, query, perl=T)
  query[-ind] <- NA
  query
}


Numers <- '../output/snakemake_out_sf3b1_blood_DarmanJuncs/CountTableNumerators.gz'
Denoms <- '../output/snakemake_out_sf3b1_blood_DarmanJuncs/CountTableDenominators.gz'

NumeratorCountTable <- fread(paste0("gunzip -c ", Numers), sep=" ", header=TRUE, data.table=FALSE)
DenominatorCountTable <- fread(paste0("gunzip -c ", Denoms), sep=" ", header=TRUE, data.table=FALSE)

dim <- NumeratorCountTable[-1]/DenominatorCountTable[-1]
row.names(PSI_Table) <- gsub(":clu_.+", "", NumeratorCountTable$chrom)
colnames(PSI_Table) <- gsub(".+\\.(.+$)", "\\1", colnames(PSI_Table), perl=T)

#Replace NaNs from 0/0 operation
PSI_Table[is.na(PSI_Table)] <- 0

# DifferentialJunctionsList <- read.table('/Users/benfair/Downloads/Seiler_S3B1InBRCA_DifferentialJunctions.txt', header=F)
DifferentialJunctionsList <- read.table('../data/other/shanes_first_batch_of_targets.DarmanMatchedIntrons.hg38.bed', header=F)

# Make new id, for easier use in later filtering. Note that coordinates may need to add 1
DifferentialJunctionsList$junc_id <- paste(DifferentialJunctionsList$V1, DifferentialJunctionsList$V2 + 1, DifferentialJunctionsList$V3 + 1, sep=":")

# PCA using PSI
PCResults <- (PSI_Table) %>%
  filter(rownames(.) %in% DifferentialJunctionsList$junc_id) %>%
  t() %>%
  prcomp(center=T, scale=T) 


#Read in metadata for SRA2
SRA2Metadata <- fread('../output/snakemake_out_sf3b1_blood_DarmanJuncs/SnaptronMetadata.SRA2.txt.gz', header=TRUE, sep='\t', na.strings = "NA", stringsAsFactors = F)
SRA2Metadata$rail_id <- as.character(SRA2Metadata$rail_id)
SRA2Metadata$source <- "SRA2"

#Read in metadata for GTEX
GTEXMetadata <- read.delim('../output/snakemake_out_sf3b1_blood_DarmanJuncs/SnaptronMetadata.GTEX.txt.gz', header=TRUE, sep='\t', na.strings = "NA", stringsAsFactors = F)
GTEXMetadata$rail_id <- as.character(GTEXMetadata$rail_id)
GTEXMetadata$source <- "GTEX"

#Read in metadata for TCGA
TCGAMetadata <- read.delim('../output/snakemake_out_sf3b1_blood_DarmanJuncs/SnaptronMetadata.TCGA.txt.gz', row.names=1, na.strings = "NA", stringsAsFactors = T, header=T)

# truncated TCGA barcodes are easier to match and merge with Seiller et al metadata
TCGAMetadata$TruncatedTCGA <- gsub("-[0-9]{2}[A-Z]-[0-9]{2}[A-Z]", "", TCGAMetadata$gdc_cases.samples.portions.analytes.submitter_id)
TCGAMetadata$rail_id <- row.names(TCGAMetadata)
TCGAMetadata$source <- "TCGA"

# Read in Mutations list metadata from Seiller et al and add to metadata
MutationList <- data.frame(read_excel("../data/other_snakemake_data/SeillerEtAl_MutationList.xlsx"))
MutationList$TruncatedTCGA <- gsub("-[0-9]{2}[A-Z]-[0-9]{2}[A-Z]-\\w{4}-\\w{2}$", "", MutationList$Tumor_Sample_Barcode)

# Add labels to help distinguish SF3B1 hotspot mutations from other SF3B1 mutations in plot
MutationList$Mutant_aa <- paste(MutationList$Hugo_Symbol, MutationList$Protein_position, MutationList$Amino_acids, sep=":")
MutationList$Mutant_aa[which(MutationList$Hugo_Symbol!="SF3B1")] <- NA


Metadata <- MutationList %>%
  filter(Amino_acids != ".") %>%
  distinct(TruncatedTCGA, .keep_all=TRUE) %>%
  right_join(TCGAMetadata, by = "TruncatedTCGA", copy = FALSE) %>% 
  full_join(SRA2Metadata, by = c("junction_coverage", "junction_avg_coverage", "rail_id", "source")) %>%
  full_join(GTEXMetadata, by = c("junction_coverage", "junction_avg_coverage", "rail_id", "source")) %>%
  filter(rail_id!="1") %>% 
  mutate(sf3b1status = gsub2('.+?\\"(sf3b1.+?:.+?)\\".+', "\\1", characteristics.y)) %>%
  unite("Combined.sf3b1", sf3b1status, Mutant_aa)

Metadata$Combined.sf3b1[which(Metadata$Combined.sf3b1=="NA_NA")] <- NA

BloodContrast <- read.table("../data/other_snakemake_data/GTEX_Blood_sf3b1.groups", col.names = c("file", "groups"))
BloodContrast$railid <- gsub(".+\\.(.+$)", "\\1", BloodContrast$file, perl=T)

# Rename rows for easier merging later
PCResults.df <- as.data.frame(PCResults$x)
PCResults.df$rail_id <- sub("juncfiles\\..+?\\.", "", rownames(PCResults.df))
ToPlot <- left_join(PCResults.df, Metadata, by = "rail_id")

ggplot(ToPlot, aes(x=PC1, y=PC2, label=Combined.sf3b1, color=source)) + 
  geom_point(alpha=1) + 
  geom_text_repel(size=2, color="black") +
  theme(legend.title = element_blank(), legend.text=element_text(size=6)) +
  theme_bw()

```

I should double check that the GTEx blood sample here is in fact the same sample identified (and confirmed through genotype) as sf3b1 mutant in the SF3B1ness-score paper on Bioarxiv (SRR1374647).


```{r}
ToPlot %>% filter(source=="GTEX" & PC1>10) %>% select(Run)

ToPlot %>% filter(source=="GTEX" & PC1<10) %>% dim()
```


Great, it is. Now replot for communicating results for lab presentation... Just include all the known wildtypes and mutants from SRA, as well as say 30 GTEx whole blood samples to illustrate the point: that splicing measurements at these 70 junctions can clearly distinguish wildtype from mutant in both bone marrow and whole blood.

```{r}
ToPlotForLabMeeting <- rbind(
  
  # The GTEx blood sf3b1-mut sample
  ToPlot %>%
    filter(source=="GTEX" & PC1>10),
  
  # 30 sf3b1-wt samples
  ToPlot %>%
    filter(source=="GTEX" & PC1<10) %>%
    sample_n(30),
  
  # All labelled SRA2 samples
  ToPlot %>%
    filter(!Combined.sf3b1=="") %>%
    filter(!source_name=="BONE MARROW")
    
)


#Lets redo the PCA using only these samples before plotting
PCResults <- (PSI_Table[,ToPlotForLabMeeting$rail_id]) %>%
  filter(rownames(.) %in% DifferentialJunctionsList$junc_id) %>%
  t() %>%
  prcomp(center=T, scale=T) 

PCResults.df <- as.data.frame(PCResults$x)
PCResults.df$rail_id <- sub("juncfiles\\..+?\\.", "", rownames(PCResults.df))
ToPlot <- left_join(PCResults.df, Metadata, by = "rail_id")

ToPlot <- ToPlot %>% mutate(RNA.source = case_when(
  source_name == "CD34+ CELLS, MDS, SF3B1 MUTATED" ~ "CD34+ Marrow cells, MDS patient",
  source_name == "CD34+ CELLS, HEALTHY CONTROL" ~ "CD34+ Marrow cells, healthy patient",
  source_name == "CD34+ CELLS, MDS, SF3B1 WILDTYPE" ~ "CD34+ Marrow cells, MDS patient",
  is.na(source_name) ~ "GTEx whole blood")) %>%
  mutate(SF3B1.status = case_when(
  PC1 <= 5 ~ "Mutant",
  PC1 >= 5 ~ "Wildtype"))

ggplot(ToPlot, aes(x=PC1, y=PC2, color=RNA.source)) + 
  geom_point(alpha=1, aes(shape=SF3B1.status)) + 
  theme(legend.title = element_blank(), legend.text=element_text(size=6)) +
  theme_bw()


```

